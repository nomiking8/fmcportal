{% extends "base.html" %}
{% block title %}
    View FMC Data
{% endblock %}
{% block content %}
<div>
    <h2>View FMC Data</h2>
    <form method="GET" action="{{ url_for('view_fmc') }}">
        <input type="text" name="search" value="{{ search }}" placeholder="Search by NOC ID">
        <input type="submit" value="Search">
    </form>
    <a href="{{ url_for('export_fmc', search=search) }}">Export to Excel</a>
    <table border="1">
        <tr>
            <th>ID</th>
            <th>Category</th>
            <th>Domain</th>
            <th>NOC ID</th>
            <th>Created By</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Details</th>
            {% if user_role == 'master' %}
            <th>Actions</th>
            {% endif %}
        </tr>
        {% for fmc in fmcs.items %}
        <tr>
            <td>{{ fmc.id }}</td>
            <td>{{ fmc.category }}</td>
            <td>{{ fmc.domain }}</td>
            <td>{{ fmc.cable_cut_noc_id or '-' }}</td>
            <td>{{ fmc.created_by }}</td>
            <td>{{ fmc.created_at_formatted }}</td>
            <td>{{ fmc.updated_at_formatted }}</td>
            <td>
                <button data-id="{{ fmc.id }}" class="view-details">View Details</button>
            </td>
            {% if user_role == 'master' %}
            <td>
                <a href="{{ url_for('edit', id=fmc.id) }}">Edit</a>
                <form action="{{ url_for('delete', id=fmc.id) }}" method="POST" style="display:inline;"
                      onsubmit="return confirm('Are you sure you want to delete this entry?');">
                    <input type="submit" value="Delete">
                </form>
            </td>
            {% endif %}
        </tr>
        {% endfor %}
    </table>
    {% if fmcs.items %}
    <div>
        {% if fmcs.has_prev %}
        <a href="{{ url_for('view_fmc', page=fmcs.prev_num, search=search) }}">Previous</a>
        {% endif %}
        {% for num in fmcs.iter_pages() %}
        {% if num %}
        {% if num == fmcs.page %}
        <span>{{ num }}</span>
        {% else %}
        <a href="{{ url_for('view_fmc', page=num, search=search) }}">{{ num }}</a>
        {% endif %}
        {% else %}
        <span>...</span>
        {% endif %}
        {% endfor %}
        {% if fmcs.has_next %}
        <a href="{{ url_for('view_fmc', page=fmcs.next_num, search=search) }}">Next</a>
        {% endif %}
    </div>
    {% endif %}
    <div id="modal" style="display:none;">
        <div>
            <h3>FMC Details</h3>
            <div id="modal-content"></div>
            <button id="close-modal">Close</button>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('.view-details').click(function () {
            const fmcId = $(this).data('id');
            $.get('/api/fmc/' + fmcId, function (data) {
                const createdAt = new Date(data.created_at).toLocaleString('en-US', {
                    timeZone: 'Asia/Karachi',
                    month: 'numeric',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    second: 'numeric',
                    hour12: true
                });
                const updatedAt = new Date(data.updated_at).toLocaleString('en-US', {
                    timeZone: 'Asia/Karachi',
                    month: 'numeric',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    second: 'numeric',
                    hour12: true
                });
                const jointTypes = data.joint_types.map(jt => jt.joint_type).join(', ') || '-';
                const pipeInfo = data.pipe_info[0] || {};
                const html = `
                    <p><strong>Category:</strong> ${data.category}</p>
                    <p><strong>Domain:</strong> ${data.domain}</p>
                    <p><strong>NOC ID:</strong> ${data.cable_cut_noc_id || '-'}</p>
                    <p><strong>Cable Used (m):</strong> ${data.cable_used_meters ? data.cable_used_meters.toFixed(2) : '-'}</p>
                    <p><strong>Cable Type:</strong> ${data.cable_type || '-'}</p>
                    <p><strong>Cable Capacity:</strong> ${data.cable_capacity || '-'}</p>
                    <p><strong>No. of Joints:</strong> ${data.no_of_joints || '-'}</p>
                    <p><strong>Joint Types:</strong> ${jointTypes}</p>
                    <p><strong>Pipe Information:</strong></p>
                    <p style="margin-left: 20px;"><strong>Pipe Used (m):</strong> ${pipeInfo.pipe_used_meters ? pipeInfo.pipe_used_meters.toFixed(2) : '-'}</p>
                    <p style="margin-left: 20px;"><strong>Pipe Size (in):</strong> ${pipeInfo.pipe_size_inches ? pipeInfo.pipe_size_inches.toFixed(2) : '-'}</p>
                    <p style="margin-left: 20px;"><strong>Pipe Type:</strong> ${pipeInfo.pipe_type || '-'}</p>
                    <p><strong>Created By:</strong> ${data.created_by}</p>
                    <p><strong>Created:</strong> ${createdAt}</p>
                    <p><strong>Updated By:</strong> ${data.updated_by}</p>
                    <p><strong>Updated At:</strong> ${updatedAt}</p>
                `;
                $('#modal-content').html(html);
                $('#modal').show();
            });
        });
        $('#close-modal').click(function () {
            $('#modal').hide();
        });
    });
</script>
{% endblock %}