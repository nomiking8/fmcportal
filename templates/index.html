{% extends "base.html" %}

{% block title %}
    FMC Dashboard
{% endblock %}

{% block content %}
<!-- Main Content -->
<main class="container mx-auto px-4 py-6">
    <h2 class="text-3xl font-bold mb-6 text-gray-800">FMC Deployment Analytics</h2>

    <!-- Summary Section -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Total FMC Entries -->
        <div class="backdrop-blur-md bg-gradient-to-br from-purple-500 to-indigo-700 rounded-xl p-4 sm:p-6 shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-purple-300">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-white">Total FMC Entries</h2>
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2z"></path>
                </svg>
            </div>
            <p class="text-2xl sm:text-4xl font-bold mt-2 text-yellow-300">{{ total_entries }}</p>
            <div class="mt-3 grid grid-cols-2 gap-2">
                <div class="flex items-center justify-center bg-purple-600/30 rounded-lg py-1">
                    <span class="text-xs sm:text-sm font-semibold text-white">Longhaul:</span>
                    <span class="ml-1 text-xs sm:text-sm font-bold text-yellow-200">{{ longhaul_count }}</span>
                </div>
                <div class="flex items-center justify-center bg-purple-600/30 rounded-lg py-1">
                    <span class="text-xs sm:text-sm font-semibold text-white">GPON FMC:</span>
                    <span class="ml-1 text-xs sm:text-sm font-bold text-yellow-200">{{ gpon_fmc_count }}</span>
                </div>
            </div>
        </div>

        <!-- Total Cable Used -->
        <div class="backdrop-blur-md bg-gradient-to-br from-blue-500 to-teal-600 rounded-xl p-4 sm:p-6 shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-blue-300">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-white">Total Cable Used (m)</h2>
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </div>
            <p class="text-2xl sm:text-4xl font-bold mt-2 text-green-300">{{ '%d'|format(total_cable_used|int) }}</p>
            <p class="text-sm text-gray-100">Total meters of cable deployed</p>
        </div>

        <!-- Total Joints -->
        <div class="backdrop-blur-md bg-gradient-to-br from-red-500 to-orange-600 rounded-xl p-4 sm:p-6 shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-red-300">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-white">Total Joints</h2>
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m-4-4h8"></path>
                </svg>
            </div>
            <p class="text-2xl sm:text-4xl font-bold mt-2 text-yellow-200">{{ total_joints }}</p>
            <p class="text-sm text-gray-100">Total number of cable joints</p>
        </div>

        <!-- Total Pipe Used -->
        <div class="backdrop-blur-md bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-4 sm:p-6 shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border border-green-300">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-white">Total Pipe Used (m)</h2>
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6"></path>
                </svg>
            </div>
            <p class="text-2xl sm:text-4xl font-bold mt-2 text-yellow-300">{{ '%d'|format(total_pipe_used|int) }}</p>
            <p class="text-sm text-gray-100">Total meters of pipe deployed</p>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <!-- Category Count -->
        <div class="backdrop-blur-md bg-white/30 rounded-xl p-4 sm:p-6 shadow-lg animate-bounce-in">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">FMC by Category</h2>
            <div class="relative h-64 sm:h-80">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>

        <!-- Domain Count -->
        <div class="backdrop-blur-md bg-white/30 rounded-xl p-4 sm:p-6 shadow-lg animate-bounce-in">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">FMC by Domain</h2>
            <div class="relative h-64 sm:h-80">
                <canvas id="domainChart"></canvas>
            </div>
        </div>

        <!-- Cable Type Distribution -->
        <div class="backdrop-blur-md bg-white/30 rounded-xl p-4 sm:p-6 shadow-lg animate-bounce-in">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Cable Type Distribution</h2>
            <div class="relative h-64 sm:h-80">
                <canvas id="cableTypeChart"></canvas>
            </div>
        </div>

        <!-- Pipe Type Distribution -->
        <div class="backdrop-blur-md bg-white/30 rounded-xl p-4 sm:p-6 shadow-lg animate-bounce-in">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">Pipe Type Distribution</h2>
            <div class="relative h-64 sm:h-80">
                <canvas id="pipeTypeChart"></canvas>
            </div>
        </div>

        <!-- NOC ID by Year -->
        <div class="backdrop-blur-md bg-white/30 rounded-xl p-4 sm:p-6 shadow-lg animate-bounce-in">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">NOC ID Count by Year</h2>
            <div class="relative h-64 sm:h-80">
                <canvas id="yearChart"></canvas>
            </div>
        </div>

        <!-- Monthly Trend -->
        <div class="backdrop-blur-md bg-white/30 rounded-xl p-4 sm:p-6 shadow-lg animate-bounce-in">
            <h2 class="text-lg font-semibold text-gray-700 mb-4">FMC Entries Over Time</h2>
            <div class="relative h-64 sm:h-80">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Entries Table -->
    <div class="bg-white shadow-xl rounded-lg overflow-x-auto">
        <h2 class="text-lg font-semibold text-gray-700 p-4">Recent FMC Entries</h2>
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-teal-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase tracking-wider">ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase tracking-wider">Domain</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase tracking-wider">NOC ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase tracking-wider">Created By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase tracking-wider">Created At</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for fmc in entries %}
                <tr class="hover:bg-teal-50 transition-colors duration-200">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ fmc.id }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ fmc.category }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ fmc.domain }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ fmc.cable_cut_noc_id or '-' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ fmc.created_by }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {{ fmc.created_at.replace(tzinfo=pytz.UTC).astimezone(pytz.timezone('Asia/Karachi')).strftime('%-m/%-d/%Y, %-I:%M:%S %p') }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</main>
{% endblock %}

{% block scripts %}
<style>
    /* Custom Animations */
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    @keyframes bounceIn {
        0% { transform: scale(0.9); opacity: 0; }
        50% { transform: scale(1.05); opacity: 0.7; }
        70% { transform: scale(0.95); }
        100% { transform: scale(1); opacity: 1; }
    }
    .animate-fade-in {
        animation: fadeIn 0.8s ease-in-out;
    }
    .animate-bounce-in {
        animation: bounceIn 0.8s ease-out;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Data from Flask
        const userCategory = {{ user_category|tojson|safe }};
        const userDomain = {{ user_domain|tojson|safe }};
        const categoryLabels = {{ category_labels|tojson|safe }};
        const categoryCounts = {{ category_counts|tojson|safe }};
        const domainLabels = {{ domain_labels|tojson|safe }};
        const domainCounts = {{ domain_counts|tojson|safe }};
        const cableTypeLabels = {{ cable_type_labels|tojson|safe }};
        const cableTypeCounts = {{ cable_type_counts|tojson|safe }};
        const pipeTypeLabels = {{ pipe_type_labels|tojson|safe }};
        const pipeTypeCounts = {{ pipe_type_counts|tojson|safe }};
        const yearLabels = {{ year_labels|tojson|safe }};
        const yearCounts = {{ year_counts|tojson|safe }};
        const monthlyLabels = {{ monthly_labels|tojson|safe }};
        const monthlyCounts = {{ monthly_counts|tojson|safe }};

        // Category Chart
        try {
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: categoryLabels,
                    datasets: [{
                        label: 'FMC Entries',
                        data: categoryCounts,
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: '#4f46e5',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#4a5568' }, grid: { color: '#e2e8f0' } },
                        x: { ticks: { color: '#4a5568' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'FMC Distribution by Category', color: '#2d3748', font: { size: 14 } }
                    }
                }
            });
        } catch (error) {
            console.error('Error rendering Category Chart:', error);
        }

        // Domain Chart
        try {
            const domainCtx = document.getElementById('domainChart').getContext('2d');
            new Chart(domainCtx, {
                type: 'bar',
                data: {
                    labels: domainLabels,
                    datasets: [{
                        label: 'FMC Entries',
                        data: domainCounts,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#4a5568' }, grid: { color: '#e2e8f0' } },
                        x: { ticks: { color: '#4a5568', maxRotation: 45, minRotation: 45 } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'FMC Distribution by Domain', color: '#2d3748', font: { size: 14 } }
                    }
                }
            });
        } catch (error) {
            console.error('Error rendering Domain Chart:', error);
        }

        // Cable Type Chart
        try {
            const cableTypeCtx = document.getElementById('cableTypeChart').getContext('2d');
            new Chart(cableTypeCtx, {
                type: 'pie',
                data: {
                    labels: cableTypeLabels,
                    datasets: [{
                        data: cableTypeCounts,
                        backgroundColor: ['#22c55e', '#ef4444', '#facc15', '#3b82f6'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#4a5568', font: { size: 12 } } },
                        title: { display: true, text: 'Cable Type Distribution', color: '#2d3748', font: { size: 14 } }
                    }
                }
            });
        } catch (error) {
            console.error('Error rendering Cable Type Chart:', error);
        }

        // Pipe Type Chart
        try {
            const pipeTypeCtx = document.getElementById('pipeTypeChart').getContext('2d');
            new Chart(pipeTypeCtx, {
                type: 'pie',
                data: {
                    labels: pipeTypeLabels,
                    datasets: [{
                        data: pipeTypeCounts,
                        backgroundColor: ['#22c55e', '#ef4444', '#facc15', '#3b82f6'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: '#4a5568', font: { size: 12 } } },
                        title: { display: true, text: 'Pipe Type Distribution', color: '#2d3748', font: { size: 14 } }
                    }
                }
            });
        } catch (error) {
            console.error('Error rendering Pipe Type Chart:', error);
        }

        // NOC ID by Year Chart
        try {
            const yearCtx = document.getElementById('yearChart').getContext('2d');
            new Chart(yearCtx, {
                type: 'bar',
                data: {
                    labels: yearLabels,
                    datasets: [{
                        label: 'NOC IDs',
                        data: yearCounts,
                        backgroundColor: 'rgba(234, 88, 12, 0.8)',
                        borderColor: '#ea580c',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#4a5568' }, grid: { color: '#e2e8f0' } },
                        x: { ticks: { color: '#4a5568' } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'NOC ID Count by Year', color: '#2d3748', font: { size: 14 } }
                    }
                }
            });
        } catch (error) {
            console.error('Error rendering Year Chart:', error);
        }

        // Monthly Trend Chart
        try {
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: monthlyLabels,
                    datasets: [{
                        label: 'FMC Entries',
                        data: monthlyCounts,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#4a5568' }, grid: { color: '#e2e8f0' } },
                        x: { ticks: { color: '#4a5568', maxRotation: 45, minRotation: 45 } }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'FMC Entries Over Time', color: '#2d3748', font: { size: 14 } }
                    }
                }
            });
        } catch (error) {
            console.error('Error rendering Monthly Chart:', error);
        }
    });
</script>
{% endblock %}